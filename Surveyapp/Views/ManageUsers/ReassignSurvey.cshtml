@model IEnumerable<Surveyapp.Models.Survey>
@inject UserManager<ApplicationUser> _userManager;
@inject RoleManager<IdentityRole> roleManager;
@{
    ViewData["Title"] = "Survey Owner";
}
<h1 class="text-warning">Update survey's owner</h1>
@if (Model.Any())
{
    foreach (var survey in Model)
    {
        <form method="post" class="mt-3">
            <input type="hidden" asp-for="@survey.Id" />
            <input type="hidden" asp-for="@survey.status" />
            <input type="hidden" asp-for="@survey.approvalStatus" />
            <div class="form-group row">
                <label asp-for="@survey.name" class="col-sm-2 col-form-label">Survey Title/Name</label>
                <div class="col-sm-10">
                    <input asp-for="@survey.name" class="form-control" disabled />
                </div>
            </div>
            <div class="form-group row">
                <label asp-for="@survey.Startdate" class="col-sm-2 col col-form-label">Open From</label>
                <div class="col-sm-10">
                    <input asp-for="@survey.Startdate" class="form-control" disabled />
                </div>
            </div>
            <div class="form-group row">
                <label asp-for="@survey.EndDate" class="col-sm-2 col col-form-label">Until</label>
                <div class="col-sm-10">
                    <input asp-for="@survey.EndDate" class="form-control" disabled />
                </div>
            </div>
            @{
                var user = await _userManager.FindByIdAsync(survey.SurveyerId);
                var owner = user.UserName;
            }
            <div class="form-group row">
                <label class="col-sm-2 col col-form-label">Current User</label>
                <div class="col-sm-10">
                    <input class="form-control" disabled value="@owner" />
                </div>
            </div>
            <div class="form-group row">
                <label asp-for="@survey.SurveyerId" class="col-sm-2 col col-form-label">Select a New Owner</label>
                <div class="col-sm-10">
                    <select id="myid" onchange="return warn('@survey.name','@owner')" asp-for="@survey.SurveyerId">
                        <option selected disabled></option>
                        @{
                            var role = await roleManager.FindByNameAsync("Surveyor");
                            var dic = new Dictionary<string, string>();

                            foreach (var _user in _userManager.Users)
                            {
                                if (await _userManager.IsInRoleAsync(_user, role.Name) && _user.Id != survey.SurveyerId)
                                {
                                    dic.Add(_user.Id, _user.UserName);
                                    <option value="@_user.Id">@_user.UserName</option>
                                }
                            }
                        }
                    </select>
                </div>
            </div>
            <input type="submit" value="Save Changes" class="btn btn-outline-warning" />
            <a class="btn btn-success"
               asp-action="UserSurvey" asp-controller="ManageUsers">
                Go Back
            </a>
            <div asp-validation-summary="ModelOnly" class="text-danger">
            </div>
        </form>
    }
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>        
        function warn(survey, first) {

            confirm('Are you sure you want to change owner of \nsurvey: ' + survey + '\nfrom \n ' + first + ' \t to \t ' + $("#myid option:selected").text());
        }
    </script>
}
